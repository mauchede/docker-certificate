#!/bin/bash
set -ex
cd "$(dirname "$0")/.."

fail() {
    echo 1>&2 "$1"
    echo 1>&2 "Usage: $(basename "$0") [NODE NAME] [DOMAIN|IP]"
    exit 1
}

if [ "$#" -lt 2 ] ; then
    fail "Invalid number of arguments"
fi

CA_KEY_FILE="${CA_KEY_FILE:-certificates/ca-key.pem}"
if [ ! -f "${CA_KEY_FILE}" ] ; then
    fail "CA private key \"${CA_KEY_FILE}\" can not be found."
fi

CA_FILE="${CA_FILE:-certificates/ca.pem}"
if [ ! -f "${CA_FILE}" ] ; then
    fail "CA certificate \"${CA_FILE}\" can not be found."
fi

NODE_KEY_FILE="${NODE_KEY_FILE:-certificates/$1-key.pem}"
if [ ! -f "${NODE_KEY_FILE}" ] ; then
    openssl genrsa -out $NODE_KEY_FILE 2048
fi

NODE_CONFIG_FILE="${NODE_CONFIG_FILE:-certificates/$1-openssl.cnf}"
if [ ! -f "${NODE_CONFIG_FILE}" ] ; then
    if [[ "$2" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]] ; then
        cp "src/openssl-ip.cnf" "${NODE_CONFIG_FILE}"
        sed -i "s/%IP%/$2/g" "${NODE_CONFIG_FILE}"
    else
        cp "src/openssl-domain.cnf" "${NODE_CONFIG_FILE}"
        SUBJ="${SUBJ}/CN=$2"
    fi
fi

NODE_CSR_FILE="${NODE_CSR_FILE:-certificates/$1.csr}"
if [ ! -f "${NODE_CSR_FILE}" ] ; then
    SUBJ="${SUBJ}/C=${CA_C:-"FR"}"
    if [ -n "${CA_CN}" ] ; then
        SUBJ="${SUBJ}/CN=${CA_CN}"
    fi

    openssl req -config "${NODE_CONFIG_FILE}" -key "${NODE_KEY_FILE}" -new -subj "${SUBJ}" -out "${NODE_CSR_FILE}"
fi

NODE_CA_FILE="${NODE_CA_FILE:-certificates/$1-cert.pem}"
if [ ! -f "${NODE_CA_FILE}" ] ; then
    openssl x509 -CA "${CA_FILE}" -CAkey "${CA_KEY_FILE}" -CAcreateserial -days 1825 -extfile "${NODE_CONFIG_FILE}" -extensions v3_req -in "${NODE_CSR_FILE}" -out "${NODE_CA_FILE}" -req
fi

exit 0
